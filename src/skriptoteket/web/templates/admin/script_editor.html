{% extends "base.html" %}

{% block head_extra %}
  <link rel="stylesheet" href="/static/vendor/codemirror/codemirror.min.css" />
  <style>
    main { max-width: 1200px; }
    .layout { display: grid; grid-template-columns: 340px 1fr; gap: 16px; align-items: start; }
    .muted { color: #666; }
    .code-editor .CodeMirror { border: 1px solid #eee; border-radius: 8px; min-height: 420px; }
    .tabs { display: flex; gap: 10px; flex-wrap: wrap; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f4f4f4; font-size: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    iframe.preview { width: 100%; min-height: 260px; border: 1px solid #eee; border-radius: 8px; }
    .stack > * + * { margin-top: 10px; }
  </style>
{% endblock %}

{% block content %}
  <div class="card stack">
    <div>
      <h2 style="margin: 0">Skripteditor</h2>
      <div class="muted">
        <strong>{{ tool.title }}</strong> <small>({{ tool.slug }})</small>
      </div>
      <div class="muted" style="margin-top: 6px">
        <span class="pill">Publicerad: {{ "Ja" if tool.is_published else "Nej" }}</span>
        <span class="pill">Aktiv version: {{ tool.active_version_id or "—" }}</span>
      </div>
    </div>

    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}

    <div class="layout">
      <div class="card stack">
        <div style="display: flex; justify-content: space-between; align-items: baseline">
          <strong>Versioner</strong>
          <button
            type="button"
            hx-get="/admin/tools/{{ tool.id }}/versions"
            hx-target="#version-list"
            hx-swap="innerHTML"
          >
            Uppdatera
          </button>
        </div>
        <div id="version-list">
          {% include "admin/partials/version_list.html" %}
        </div>
      </div>

      <div class="card stack">
        <div class="muted">
          {% if selected_version %}
            <span class="pill">Version {{ selected_version.version_number }}</span>
            <span class="pill">{{ selected_version.state }}</span>
            <span class="pill">ID: {{ selected_version.id }}</span>
          {% else %}
            <span class="pill">Ingen sparad version ännu</span>
          {% endif %}
        </div>

        <form
          id="editor-form"
          class="stack"
          method="post"
          action="{{ save_action }}"
        >
          {% if save_mode == "snapshot" %}
            <input type="hidden" name="expected_parent_version_id" value="{{ selected_version.id }}" />
          {% endif %}
          {% if derived_from_version_id %}
            <input type="hidden" name="derived_from_version_id" value="{{ derived_from_version_id }}" />
          {% endif %}
          <label>
            Entrypoint
            <input name="entrypoint" value="{{ editor_entrypoint }}" />
          </label>

          <div class="code-editor">
            <label for="source_code">Kod</label>
            <textarea id="source_code" name="source_code">{{ editor_source_code }}</textarea>
          </div>

          <label>
            Change summary (valfritt)
            <input name="change_summary" value="" />
          </label>

          <div style="display: flex; gap: 10px; flex-wrap: wrap">
            <button type="submit">
              {% if save_mode == "snapshot" %}
                Spara (ny snapshot)
              {% else %}
                Skapa utkast
              {% endif %}
            </button>

            {% if selected_version %}
              <a href="/admin/tools/{{ tool.id }}">Öppna standardvy</a>
            {% endif %}
          </div>
        </form>

        <hr style="border: none; border-top: 1px solid #eee" />

        <div class="card stack">
          <strong>Sandbox-körning</strong>
          {% if not selected_version %}
            <p class="muted"><small>Spara ett utkast innan du kör sandbox.</small></p>
          {% else %}
            <form
              id="run-form"
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
              enctype="multipart/form-data"
              hx-post="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
              hx-target="#run-result"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
            >
              <input type="hidden" name="tool_id" value="{{ tool.id }}" />
              <label>
                <small>Välj testfil för körning</small>
                <input type="file" name="file" required style="margin-top: 4px" />
              </label>
              <button type="submit">Kör sandbox</button>
            </form>
          {% endif %}
        </div>

        <div class="card stack">
          <strong>Submit for review</strong>
          {% if selected_version %}
            <form
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/submit-review"
            >
              <label>
                Review note (valfritt)
                <input name="review_note" value="" />
              </label>
              <button type="submit">Skicka för granskning</button>
            </form>
          {% else %}
            <p class="muted"><small>Spara ett utkast först.</small></p>
          {% endif %}
        </div>

        <div id="run-result" class="stack">
          {% if run %}
            {% include "admin/partials/run_result.html" %}
          {% else %}
            <p class="muted"><small>Inga sandbox-resultat ännu.</small></p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts_extra %}
  <script src="/static/vendor/codemirror/codemirror.min.js" defer></script>
  <script src="/static/vendor/codemirror/mode/python/python.min.js" defer></script>
  <script>
    (function () {
      var initialized = false;

      function init() {
        if (initialized) return;
        if (!window.CodeMirror) return;
        var textarea = document.getElementById("source_code");
        if (!textarea) return;

        var editor = window.CodeMirror.fromTextArea(textarea, {
          lineNumbers: true,
          mode: "python",
          indentUnit: 4,
          tabSize: 4,
        });

        function sync() {
          editor.save();
        }

        var editorForm = document.getElementById("editor-form");
        if (editorForm) editorForm.addEventListener("submit", sync);
        document.body.addEventListener("htmx:configRequest", sync);

        initialized = true;
      }

      document.addEventListener("DOMContentLoaded", init);
      window.addEventListener("load", init);
    })();
  </script>
{% endblock %}
