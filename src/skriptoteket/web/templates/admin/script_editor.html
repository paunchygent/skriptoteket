{% extends "base.html" %}

{% block main_class %}huleedu-main-fluid huleedu-editor-page{% endblock %}

{% block content %}
  <div class="huleedu-card huleedu-mb-4">
    <div class="huleedu-flex-between">
      <div>
        <h2 style="margin: 0">Skripteditorn</h2>
        <div class="huleedu-muted">
          <strong>{{ tool.title }}</strong> <small>({{ tool.slug }})</small>
        </div>
      </div>
      <div class="huleedu-text-right">
        <div class="huleedu-pills huleedu-editor-status-pills">
          <span class="huleedu-pill">{{ "Publicerad" if tool.is_published else "Ej publicerad" }}</span>
          {% if selected_version %}
            <span class="huleedu-pill huleedu-pill-active">Redigerar v{{ selected_version.version_number }}</span>
          {% else %}
            <span class="huleedu-pill">Nytt utkast</span>
          {% endif %}
        </div>
      </div>
    </div>

    {% if error %}
      <p class="huleedu-error huleedu-mt-2">{{ error }}</p>
    {% endif %}
  </div>

  <div class="huleedu-editor-layout">

    <!-- COLUMN 1: Code Editor, Test Runner & Results (Main) -->
    <div class="huleedu-editor-main">
      <!-- CODE EDITOR + TEST RUNNER (unified panel) -->
      <div class="huleedu-card huleedu-editor-code-card">
        <form id="editor-form" method="post" action="{{ save_action }}" class="huleedu-editor-form">
          {% if save_mode == "snapshot" %}
            <input type="hidden" name="expected_parent_version_id" value="{{ selected_version.id }}" />
          {% endif %}
          {% if derived_from_version_id %}
            <input type="hidden" name="derived_from_version_id" value="{{ derived_from_version_id }}" />
          {% endif %}

          <label for="source_code" class="huleedu-label">Källkod</label>
          <div class="huleedu-editor-textarea-wrapper">
            <textarea id="source_code" name="source_code" class="huleedu-input huleedu-editor-textarea" data-huleedu-codemirror="python">{{ editor_source_code }}</textarea>
          </div>
        </form>

        <!-- Test runner toolbar (inside same card) -->
        <div class="huleedu-editor-toolbar">
          {% if not selected_version %}
            <span class="huleedu-muted">Spara ett utkast innan du testkör.</span>
          {% else %}
            {% if user.role in ["admin", "superuser"] or selected_version.state.value in ["draft", "in_review"] %}
              <form
                id="run-form"
                method="post"
                action="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
                enctype="multipart/form-data"
                hx-post="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
                hx-target="#run-result"
                hx-swap="innerHTML"
                hx-encoding="multipart/form-data"
                hx-indicator="#sandbox-run-indicator"
                class="huleedu-flex huleedu-gap-4 huleedu-editor-run-form"
              >
                <input type="hidden" name="tool_id" value="{{ tool.id }}" />
                <label class="huleedu-file-wrapper huleedu-input huleedu-editor-file-field">
                  <span class="huleedu-file-fake-button" aria-hidden="true">Välj fil</span>
                  <span id="file-name" class="huleedu-muted huleedu-file-name">Ingen fil vald</span>
                  <input type="file" name="file" class="huleedu-file-native" data-huleedu-file-name-target="file-name" />
                </label>
                <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-btn-icon">
                  <span id="sandbox-run-indicator" class="htmx-indicator huleedu-spinner huleedu-spinner-sm huleedu-spinner-light" aria-hidden="true"></span>
                  Testkör
                </button>
              </form>
            {% else %}
              <span class="huleedu-muted">Skapa ett utkast innan du testkör.</span>
            {% endif %}
            <span class="huleedu-toolbar-version">
              <span class="huleedu-badge">v{{ selected_version.version_number }}</span>
              <span class="huleedu-badge {% if selected_version.state.value == 'active' %}huleedu-badge-burgundy{% endif %}">{{ selected_version.state | version_state_label }}</span>
            </span>
          {% endif %}
        </div>
      </div>

      <!-- RUN RESULTS -->
      <div id="run-result">
        {% if run %}
          {% include "admin/partials/run_result.html" %}
        {% endif %}
      </div>
    </div>

    <!-- COLUMN 2: Unified Sidebar -->
    <div class="huleedu-editor-sidebar">
      <div class="huleedu-card huleedu-sidebar-unified">

        <!-- SAVE & DRAFT -->
        <section class="huleedu-sidebar-section">
          <strong class="huleedu-sidebar-heading">Redigering</strong>
          <div class="huleedu-stack-sm">
            <div>
              <label class="huleedu-label">Startfunktion</label>
              <input form="editor-form" name="entrypoint" value="{{ editor_entrypoint }}" class="huleedu-input" placeholder="main" />
            </div>
            <div>
              <label class="huleedu-label">Ändringssammanfattning</label>
              <input form="editor-form" name="change_summary" value="" class="huleedu-input" placeholder="T.ex. fixade bugg..." />
            </div>
            <button type="submit" form="editor-form" class="huleedu-btn huleedu-btn-navy huleedu-w-full">
              {% if save_mode == "snapshot" %}Spara{% else %}Skapa utkast{% endif %}
            </button>
          </div>
        </section>

        <!-- REVIEW / PUBLISH -->
        {% if selected_version %}
          <section class="huleedu-sidebar-section">
            <strong class="huleedu-sidebar-heading">Process</strong>
            <form method="post" action="/admin/tool-versions/{{ selected_version.id }}/submit-review" class="huleedu-stack-sm">
              <div>
                <label class="huleedu-label">Notis till granskare</label>
                <input name="review_note" value="" class="huleedu-input" />
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-w-full">Skicka för granskning</button>
            </form>

            {% if selected_version.state == "in_review" and user.role in ["admin", "superuser"] %}
              <div class="huleedu-stack-sm huleedu-mt-2">
                <strong class="huleedu-label">Granskning</strong>
                <form method="post" action="/admin/tool-versions/{{ selected_version.id }}/publish">
                  <button type="submit" class="huleedu-btn huleedu-w-full">Publicera</button>
                </form>
                <form method="post" action="/admin/tool-versions/{{ selected_version.id }}/request-changes">
                  <button type="submit" class="huleedu-btn huleedu-btn-secondary huleedu-w-full">Begär ändringar</button>
                </form>
              </div>
            {% endif %}
          </section>
        {% endif %}

        <!-- VERSIONS LIST -->
        <section class="huleedu-sidebar-section">
          <div class="huleedu-flex-between huleedu-mb-2">
            <strong class="huleedu-sidebar-heading">Historik</strong>
            <button type="button" class="huleedu-btn huleedu-btn-secondary huleedu-btn-sm"
                    hx-get="/admin/tools/{{ tool.id }}/versions" hx-target="#version-list" hx-swap="innerHTML">
              Uppdatera
            </button>
          </div>
          <div id="version-list" class="huleedu-version-list">
            {% include "admin/partials/version_list.html" %}
          </div>
        </section>

        <!-- METADATA -->
        {% if user.role in ["admin", "superuser"] %}
          <section class="huleedu-sidebar-section huleedu-sidebar-section-last">
            <strong class="huleedu-sidebar-heading">Metadata</strong>
            <form method="post" action="/admin/tools/{{ tool.id }}/metadata" class="huleedu-stack-sm">
              <div>
                <label for="tool_title" class="huleedu-label">Titel</label>
                <input id="tool_title" name="title" value="{{ tool.title }}" required class="huleedu-input" />
              </div>
              <div>
                <label for="tool_summary" class="huleedu-label">Sammanfattning</label>
                <input id="tool_summary" name="summary" value="{{ tool.summary or '' }}" class="huleedu-input" />
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-btn-sm">Spara metadata</button>
            </form>
          </section>
        {% endif %}

      </div>
    </div>
  </div>
{% endblock %}
