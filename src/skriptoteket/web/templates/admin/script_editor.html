{% extends "base.html" %}

{% block head_extra %}
  <link rel="stylesheet" href="/static/vendor/codemirror/codemirror.min.css" />
{% endblock %}

{% block content %}
  <div class="huleedu-card huleedu-stack">
    <div>
      <h2 style="margin: 0">Skripteditor</h2>
      <div class="huleedu-muted">
        <strong>{{ tool.title }}</strong> <small>({{ tool.slug }})</small>
      </div>
      <div class="huleedu-muted huleedu-mt-2">
        <span class="huleedu-pill">Publicerad: {{ "Ja" if tool.is_published else "Nej" }}</span>
        <span class="huleedu-pill">Aktiv version: {{ tool.active_version_id or "—" }}</span>
      </div>
    </div>

    {% if error %}
      <p class="huleedu-error">{{ error }}</p>
    {% endif %}

    <div class="huleedu-editor-layout">
      <div class="huleedu-card huleedu-stack">
        <div class="huleedu-flex-between">
          <strong>Versioner</strong>
                      <button
                      type="button"
                      class="huleedu-btn huleedu-btn-secondary huleedu-btn-sm huleedu-min-w-32"            hx-get="/admin/tools/{{ tool.id }}/versions"
            hx-target="#version-list"
            hx-swap="innerHTML"
          >
            Uppdatera
          </button>
        </div>
        <div id="version-list">
          {% include "admin/partials/version_list.html" %}
        </div>
      </div>

      <div class="huleedu-card huleedu-stack">
        {% if user.role in ["admin", "superuser"] %}
          <div class="huleedu-card-flat huleedu-stack">
            <strong>Verktygsmetadata</strong>
            <form method="post" action="/admin/tools/{{ tool.id }}/metadata" class="huleedu-stack">
              <div>
                <label for="tool_title" class="huleedu-label">Titel</label>
                <input id="tool_title" name="title" value="{{ tool.title }}" required class="huleedu-input" />
              </div>
              <div>
                <label for="tool_summary" class="huleedu-label">Sammanfattning</label>
                <textarea id="tool_summary" name="summary" class="huleedu-input">{{ tool.summary or "" }}</textarea>
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-btn-sm huleedu-min-w-32">Spara metadata</button>
            </form>
          </div>
        {% endif %}

        <div class="huleedu-muted">
          {% if selected_version %}
            <span class="huleedu-pill">Version {{ selected_version.version_number }}</span>
            <span class="huleedu-pill">{{ selected_version.state | version_state_label }}</span>
            <span class="huleedu-pill">ID: {{ selected_version.id }}</span>
          {% else %}
            <span class="huleedu-pill">Ingen sparad version ännu</span>
          {% endif %}
        </div>

        <form
          id="editor-form"
          class="huleedu-stack"
          method="post"
          action="{{ save_action }}"
        >
          {% if save_mode == "snapshot" %}
            <input type="hidden" name="expected_parent_version_id" value="{{ selected_version.id }}" />
          {% endif %}
          {% if derived_from_version_id %}
            <input type="hidden" name="derived_from_version_id" value="{{ derived_from_version_id }}" />
          {% endif %}
          <div>
            <label class="huleedu-label">Startfunktion</label>
            <input name="entrypoint" value="{{ editor_entrypoint }}" class="huleedu-input" />
          </div>

          <div class="code-editor">
            <label for="source_code" class="huleedu-label">Kod</label>
            <textarea id="source_code" name="source_code" class="huleedu-input" style="min-height: 420px; font-family: var(--huleedu-font-mono);">{{ editor_source_code }}</textarea>
          </div>

          <div>
            <label class="huleedu-label">Ändringssammanfattning (valfritt)</label>
            <input name="change_summary" value="" class="huleedu-input" />
          </div>

          <div class="huleedu-flex huleedu-gap-4" style="flex-wrap: wrap">
            <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-min-w-32">
              {% if save_mode == "snapshot" %}
                Spara (ny snapshot)
              {% else %}
                Skapa utkast
              {% endif %}
            </button>

            {% if selected_version %}
              <a href="/admin/tools/{{ tool.id }}" class="huleedu-btn huleedu-btn-secondary huleedu-min-w-32">Öppna standardvy</a>
            {% endif %}
          </div>
        </form>

        <hr style="border: none; border-top: 1px solid var(--huleedu-navy-20); margin: var(--huleedu-space-4) 0" />

        <div class="huleedu-card-flat huleedu-stack">
          <strong>Testkörning</strong>
          {% if not selected_version %}
            <p class="huleedu-muted"><small>Spara ett utkast innan du testkör.</small></p>
          {% else %}
            <form
              id="run-form"
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
              enctype="multipart/form-data"
              hx-post="/admin/tool-versions/{{ selected_version.id }}/run-sandbox"
              hx-target="#run-result"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              class="huleedu-stack-sm"
            >
              <input type="hidden" name="tool_id" value="{{ tool.id }}" />
              <div class="huleedu-form-group">
                <label class="huleedu-label">Välj testfil</label>
                <div class="huleedu-input huleedu-file-wrapper">
                  <span class="huleedu-file-fake-button">Välj fil</span>
                  <span id="file-name" class="huleedu-muted" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Ingen fil vald</span>
                  <input type="file" name="file" class="huleedu-file-native"
                         onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'Ingen fil vald'" />
                </div>
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-min-w-32">Testkör</button>
            </form>
          {% endif %}
        </div>

        <div class="huleedu-card-flat huleedu-stack">
          <strong>Skicka för granskning</strong>
          {% if selected_version %}
            <form
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/submit-review"
              class="huleedu-stack-sm"
            >
              <div>
                <label class="huleedu-label">Notis till granskare (valfritt)</label>
                <input name="review_note" value="" class="huleedu-input" />
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-navy huleedu-min-w-32">Skicka för granskning</button>
            </form>
          {% else %}
            <p class="huleedu-muted"><small>Spara ett utkast först.</small></p>
          {% endif %}
        </div>

        {% if selected_version and selected_version.state == "in_review" and user.role in ["admin", "superuser"] %}
          <div class="huleedu-card-flat huleedu-stack">
            <strong>Granska version</strong>

            <form
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/publish"
              class="huleedu-stack-sm"
            >
              <div>
                <label class="huleedu-label">Ändringssammanfattning (valfritt)</label>
                <input name="change_summary" value="" class="huleedu-input" />
              </div>
              <button type="submit" class="huleedu-btn huleedu-min-w-32">Publicera</button>
            </form>

            <form
              method="post"
              action="/admin/tool-versions/{{ selected_version.id }}/request-changes"
              class="huleedu-stack-sm"
            >
              <div>
                <label for="request_changes_message" class="huleedu-label">Meddelande (valfritt)</label>
                <textarea id="request_changes_message" name="message" class="huleedu-input"></textarea>
              </div>
              <button type="submit" class="huleedu-btn huleedu-btn-secondary huleedu-min-w-32">Begär ändringar</button>
            </form>
          </div>
        {% endif %}

        <div id="run-result" class="huleedu-stack">
          {% if run %}
            {% include "admin/partials/run_result.html" %}
          {% else %}
            <p class="huleedu-muted"><small>Inga testresultat ännu.</small></p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts_extra %}
  <script src="/static/vendor/codemirror/codemirror.min.js" defer></script>
  <script src="/static/vendor/codemirror/mode/python/python.min.js" defer></script>
  <script>
    (function () {
      var initialized = false;

      function init() {
        if (initialized) return;
        if (!window.CodeMirror) return;
        var textarea = document.getElementById("source_code");
        if (!textarea) return;

        var editor = window.CodeMirror.fromTextArea(textarea, {
          lineNumbers: true,
          mode: "python",
          indentUnit: 4,
          tabSize: 4,
        });

        function sync() {
          editor.save();
        }

        var editorForm = document.getElementById("editor-form");
        if (editorForm) editorForm.addEventListener("submit", sync);
        document.body.addEventListener("htmx:configRequest", sync);

        initialized = true;
      }

      document.addEventListener("DOMContentLoaded", init);
      window.addEventListener("load", init);
    })();
  </script>
{% endblock %}
