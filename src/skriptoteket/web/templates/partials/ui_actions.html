{# Shared rendering for stored ui_payload.next_actions (contract v2) #}
{% set context = interactive_context | default("default", true) %}
{% set expected_state_rev = interactive_state_rev | default(none) %}

{% if expected_state_rev is not none %}
  <div class="huleedu-stack">
    {% for action in next_actions %}
      {% set action_index = loop.index0 %}
      <form
        method="post"
        action="/tools/interactive/start_action"
        hx-post="/tools/interactive/start_action"
        hx-target="#result-container"
        hx-swap="innerHTML"
        class="huleedu-stack huleedu-card"
      >
        <input type="hidden" name="_run_id" value="{{ run.id }}" />
        <input type="hidden" name="_context" value="{{ context }}" />
        <input type="hidden" name="_action_id" value="{{ action.action_id }}" />
        <input type="hidden" name="_expected_state_rev" value="{{ expected_state_rev }}" />

        {% for field in action.fields %}
          {% set field_id = "run-" ~ run.id ~ "-a" ~ action_index ~ "-f" ~ loop.index0 %}

          {% if field.kind == "string" %}
            <div class="huleedu-form-group">
              <label class="huleedu-label" for="{{ field_id }}">{{ field.label }}</label>
              <input id="{{ field_id }}" name="{{ field.name }}" class="huleedu-input" />
            </div>
          {% elif field.kind == "text" %}
            <div class="huleedu-form-group">
              <label class="huleedu-label" for="{{ field_id }}">{{ field.label }}</label>
              <textarea id="{{ field_id }}" name="{{ field.name }}" class="huleedu-input"></textarea>
            </div>
          {% elif field.kind == "integer" %}
            <div class="huleedu-form-group">
              <label class="huleedu-label" for="{{ field_id }}">{{ field.label }}</label>
              <input id="{{ field_id }}" type="number" step="1" name="{{ field.name }}" class="huleedu-input" />
            </div>
          {% elif field.kind == "number" %}
            <div class="huleedu-form-group">
              <label class="huleedu-label" for="{{ field_id }}">{{ field.label }}</label>
              <input id="{{ field_id }}" type="number" step="any" name="{{ field.name }}" class="huleedu-input" />
            </div>
          {% elif field.kind == "boolean" %}
            <fieldset class="huleedu-fieldset">
              <legend>{{ field.label }}</legend>
              <div class="huleedu-checkbox-group">
                <div class="huleedu-checkbox-item">
                  <input type="checkbox" id="{{ field_id }}" name="{{ field.name }}" value="true" />
                  <label for="{{ field_id }}">Ja</label>
                </div>
              </div>
            </fieldset>
          {% elif field.kind == "enum" %}
            <fieldset class="huleedu-fieldset">
              <legend>{{ field.label }}</legend>
              <div class="huleedu-radio-group">
                {% for opt in field.options %}
                  {% set opt_id = field_id ~ "-opt" ~ loop.index0 %}
                  <div class="huleedu-radio-item">
                    <input type="radio" id="{{ opt_id }}" name="{{ field.name }}" value="{{ opt.value }}" />
                    <label for="{{ opt_id }}">{{ opt.label }}</label>
                  </div>
                {% endfor %}
              </div>
            </fieldset>
          {% elif field.kind == "multi_enum" %}
            <fieldset class="huleedu-fieldset">
              <legend>{{ field.label }}</legend>
              <div class="huleedu-checkbox-group">
                {% for opt in field.options %}
                  {% set opt_id = field_id ~ "-opt" ~ loop.index0 %}
                  <div class="huleedu-checkbox-item">
                    <input type="checkbox" id="{{ opt_id }}" name="{{ field.name }}" value="{{ opt.value }}" />
                    <label for="{{ opt_id }}">{{ opt.label }}</label>
                  </div>
                {% endfor %}
              </div>
            </fieldset>
          {% endif %}
        {% endfor %}

        <div class="huleedu-flex huleedu-gap-4">
          <button type="submit" class="huleedu-btn huleedu-btn-navy">{{ action.label }}</button>
        </div>
      </form>
    {% endfor %}
  </div>
{% endif %}
