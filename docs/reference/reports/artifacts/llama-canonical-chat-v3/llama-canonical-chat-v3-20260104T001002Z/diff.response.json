{"choices":[{"finish_reason":"stop","index":0,"message":{"role":"assistant","content":"diff --git a/archive_utils.py b/archive_utils.py\n--- a/archive_utils.py\n+++ b/archive_utils.py\n@@ -1,19 +1,28 @@\n import os\n import zipfile\n from pathlib import Path\n\n+def _is_safe_path(dest_dir: str, target_path: str) -> bool:\n+    \"\"\"Check if target_path is safe to write within dest_dir.\"\"\"\n+    dest_dir = os.path.abspath(dest_dir)\n+    target_path = os.path.abspath(target_path)\n+    return os.path.commonpath([dest_dir]) == os.path.commonpath([dest_dir, target_path])\n+\n def extract_zip(zip_path: str | Path, dest_dir: str | Path) -> None:\n     \"\"\"Extract all files from a zip into dest_dir.\"\"\"\n     dest_dir = str(dest_dir)\n     with zipfile.ZipFile(zip_path) as zf:\n         for name in zf.namelist():\n             if name.endswith(\"/\"):\n                 continue\n\n             target_path = os.path.join(dest_dir, name)\n+            if not _is_safe_path(dest_dir, target_path):\n+                continue\n+\n             os.makedirs(os.path.dirname(target_path), exist_ok=True)\n\n-            # NOTE: read() is fine here because files are usually small.\n-            with zf.open(name) as src:\n-                data = src.read()\n-            with open(target_path, \"wb\") as dst:\n-                dst.write(data)\n+            with zf.open(name) as src, open(target_path, \"wb\") as dst:\n+                while chunk := src.read(8192):\n+                    dst.write(chunk)\ndiff --git a/test_archive_utils.py b/test_archive_utils.py\n--- a/test_archive_utils.py\n+++ b/test_archive_utils.py\n@@ -25,3 +25,21 @@ def test_extract_basic(tmp_path: Path) -> None:\n     assert (out / \"a.txt\").read_bytes() == b\"hello\"\n     assert (out / \"dir\" / \"b.txt\").read_bytes() == b\"world\"\n\n+def test_extract_zip_slip_blocked(tmp_path: Path) -> None:\n+    zdata = _make_zip_bytes({\n+        \"a.txt\": b\"hello\",\n+        \"../evil.txt\": b\"bad\",\n+    })\n+    zpath = tmp_path / \"t.zip\"\n+    zpath.write_bytes(zdata)\n+\n+    out = tmp_path / \"out\"\n+    out.mkdir()\n+\n+    extract_zip(zpath, out)\n+\n+    assert (out / \"a.txt\").read_bytes() == b\"hello\"\n+    assert not (tmp_path / \"evil.txt\").exists()\n+\n+def test_extract_absolute_path_blocked(tmp_path: Path) -> None:\n+    outside = tmp_path / \"outside.txt\"\n+    zdata = _make_zip_bytes({str(outside): b\"bad\"})\n+    zpath = tmp_path / \"t.zip\"\n+    zpath.write_bytes(zdata)\n+    out = tmp_path / \"out\"\n+    out.mkdir()\n+    extract_zip(zpath, out)\n+    assert not outside.exists()"}}],"created":1767485464,"model":"Devstral-Small-2-24B-Instruct-2512-Q8_0.gguf","system_fingerprint":"b7585-0f89d2ecf","object":"chat.completion","usage":{"completion_tokens":687,"prompt_tokens":690,"total_tokens":1377},"id":"chatcmpl-1JPzKFLCR95kNqmlzjWs4b4rlo0Neukf","timings":{"cache_n":5,"prompt_n":685,"prompt_ms":1343.383,"prompt_per_token_ms":1.9611430656934308,"prompt_per_second":509.9067056825939,"predicted_n":687,"predicted_ms":36434.69,"predicted_per_token_ms":53.03448326055313,"predicted_per_second":18.85565651855416}}
